<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-rethinkdb-architecture2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/12/rethinkdb-architecture2/" class="article-date">
  <time datetime="2016-05-12T15:35:05.000Z" itemprop="datePublished">2016-05-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/12/rethinkdb-architecture2/" data-id="cio4gjlg80000fkas6z7o1izx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-rethinkdb-architecture" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/10/rethinkdb-architecture/" class="article-date">
  <time datetime="2016-05-10T14:27:51.000Z" itemprop="datePublished">2016-05-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/10/rethinkdb-architecture/">rethinkdb architecture</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Sharding-and-replication"><a href="#Sharding-and-replication" class="headerlink" title="Sharding and replication"></a>Sharding and replication</h2><h4 id="rethinkdb如何对数据进行分片？"><a href="#rethinkdb如何对数据进行分片？" class="headerlink" title="rethinkdb如何对数据进行分片？"></a>rethinkdb如何对数据进行分片？</h4><p>rethinkdb使用表主键作为输入参数的范围切分算法对数据进行分片，当用户声明想对一个表切分成一定数量的分片，系统会根据这个表的统计信息找到最优的分裂点把表平均切分。所有的划分都是基于表的primary key来完成，不能做到基于其他属性的（在rethinkdb中 ，primary key和shard key实际上是一回事）。</p>
<p>举个例子，如果一个表包含一千个json文档，它的primary key是均匀分布，字典序，大写的字符串，用户声明他们需要2个分片，rethinkdb将会挑选分裂点字母 ‘M’ 去切分这个表。每个文档如果primary key 小于等于 ‘M’将会进入第一个分片，如果primary key 大于 ‘M’ 将会进入第二个分片.分裂点的选择将会尽量让每个分片包含500个key，并且分片会自动分布到集群中。</p>
<p>即使primary key包含不平均分布的数据(比如人名，有一些名字出现的次数比其他名字更多)，系统会挑选一个恰当的分裂点去保证每个分片有大致相同数量的的文档。</p>
<p>当表创建分片之后分裂点不会自动修改，这意味着如果primary key变得分布不均匀，分片可能变的不均衡。不过，用户可以在需要的时候手动调整分片，还可以重新配置表的分片和副本集的设置，但用户不能手工设置分裂点。</p>
<p>这种机制的内部实现比常见的一致性hash更困难，但优势明显，因为它可以更高效的实现范围查询。</p>
<h4 id="集群中分片和副本集的位置是如何保证的？"><a href="#集群中分片和副本集的位置是如何保证的？" class="headerlink" title="集群中分片和副本集的位置是如何保证的？"></a>集群中分片和副本集的位置是如何保证的？</h4><p>分片和副本可以通过table configurations进行配置，可以在一个数据库很简单的对一张表或者多张表配置分片和副本集数量.用户不需要手工关联表和服务器.rethinkdb使用一套探索式方法去尝试以最优的方式去满足表配置: 从可用的服务商位新的副本拷贝数据，在集群上均匀分布数据的副本，尽量平均的分配负载等。</p>
<p>对于更细力度的机制，副本可以通过 server tags与server进行关联。每个server可以被分配一个或者多个tags，每个表可以有一定数量的副本关联到一个server的tag。举个例子，如果你有6台server，你可能对2台关联us_west的标签（tag），2台us_east标签，2个london标签，同时分配四台美国的服务器us标签。表可以通过reconfigure设置一组配置，用来对副本进行分组。</p>
<pre><code>r.table(&apos;a&apos;).reconfigure(shards=2, replicas={&apos;us_east&apos;:2, &apos;us_west&apos;:2,
    &apos;london&apos;:2}, primary_replica_tag=&apos;us_east&apos;)
r.table(&apos;b&apos;).reconfigure(shards=2, replicas={&apos;us&apos;:2, &apos;london&apos;:1},
    primary_replica_tag=&apos;london&apos;)
</code></pre><p>在第二个例子里，us组里的2个副本可能在4台美国server中的任意server上。<br>需要注意的是server的tag不能通过rethinkdb的web管理界面进行配置，但可以通过ReQL命令和脚本进行创建和赋值。</p>
<p>rethinkdb持有一个内部的目录用于跟踪集群的当前状态:目前多少server可用，每台server存储了什么数据等。这个数据结随着集群变化并自动更新。举个例子，如果一个机器因为电源故障挂了，这个目录也会更新去记录这一变化。</p>
<h4 id="如何支持多机房工作？"><a href="#如何支持多机房工作？" class="headerlink" title="如何支持多机房工作？"></a>如何支持多机房工作？</h4><p>从rethinkdb 1.16开始，早期的”数据中心”的概念已经被上述提到的server tags 替换了。一个数据中心的所有server可能都被打上一个tag，比如us_east或us_west, 一张表可以配置成关联指定服务器标签的多个副本集（比如，2个副本集在打上us_east标签的服务器上，3个副本集在打上us_west标签的服务器上）。</p>
<p>rethinkdb在一个机房和跨机房中使用相同的协议进行通讯，因为架构是 immediately consistent ，对单个文档的读写不需要quorums, rethinkdb不存在类似dynamo系统跨机房quorums所带来的延迟的问题。</p>
<h4 id="在没有用户的请求下rethinkdb会自动对数据库重新分区吗？"><a href="#在没有用户的请求下rethinkdb会自动对数据库重新分区吗？" class="headerlink" title="在没有用户的请求下rethinkdb会自动对数据库重新分区吗？"></a>在没有用户的请求下rethinkdb会自动对数据库重新分区吗？</h4><p>答案是不会，这个集群系统设计遵循了三个重要原则：<br>1.通常的操作比如伸缩，重新切片，增加或减少副本集数量应该和容易被执行通过一个按钮点击<br>2.在一些重要的情况下，系统应该给管理员调整的权限，比如指定primary和secondary replica到特定的集群服务器上。<br>3.集群的信息和集群所有的操作应该是编程可见的。</p>
<p>我们通常将集群上执行自动的维护操作(比如添加分片)看作high-level的组件，因此首先实现一个好的low-level组件就更为关键。所以这个集群系统由下面三层组成:<br>1.第一层实现了分布式基础组件:放置拷贝数据在指定的服务器上，路由查询等<br>2.第二层构建在第一层之上并且实现了多种自动化机制(自动分裂，数据拷贝放哪，自动挑选最佳primary replica)。<br>3.第三层构建在前两层之上，并且提供用户命令行和web工具去操作集群</p>
<p>没有用户的请求就能够自动调用这些功能是下一层需要做的。目前用户可以通过web UI，手工操作命令行，编写脚本去调用命令行工具来实现操作自动化</p>
<p>我们正在探索最佳实践尝试去构建一个通用的自动化层来控制集群，通过用户指定的规则来自动控制(比如当分片平衡性降到一定的阈值的时候需要重新切分)</p>
<h2 id="CAP-theorem"><a href="#CAP-theorem" class="headerlink" title="CAP theorem"></a>CAP theorem</h2><h4 id="rethinkdb是immediately还是eventually-一致性？"><a href="#rethinkdb是immediately还是eventually-一致性？" class="headerlink" title="rethinkdb是immediately还是eventually 一致性？"></a>rethinkdb是immediately还是eventually 一致性？</h4><p>在rethinkdb的每个分片都会有一个primary replica。对某个key的所有读和写一定会路由到primary replica， 在 primary replica上key是有序且经过评估的。数据总是始终保持一致，并且没有冲突，在一个已返回ack的写操作之后的读操作能够保证读到最新的写入数据。然而，如果主副本不可用，读和写都不能保证成功。</p>
<p>rethinkdb支持up-to-date和out-of-date 读。默认的所有的读都是up-to-date读，这意味着某个分片的读请求都会路由到主replica，且被顺序执行。在默认的模式下，客户端总是看到最新的，一致的， artifact-free的数据视图</p>
<p>程序员也可以标记一个读操作能容忍读到out-of-date数据。在这个模式下，读请求不必路由到primary分片，而是可能会路由到最近的副本上。out-of-date查询拥有更低的延迟和更强的可用性，但是不一定会返回客户端数据最新的版本</p>
<h4 id="rethinkdb是如何权衡cap理论？"><a href="#rethinkdb是如何权衡cap理论？" class="headerlink" title="rethinkdb是如何权衡cap理论？"></a>rethinkdb是如何权衡cap理论？</h4><p>cap理论暴露的最基本的权衡是:当网络分区时，系统保持可用性还是数据一致性?(rethinkdb选择了数据一致性)</p>
<p>dynamo类似的系统比如cassandra和ciak选择了强可用性。在这些系统中如果出现网络分区，客户端可能往网络分区的两边都写入相同的key。对保证写可用性所付出的代价是，在这之上的应用必须处理多种复杂问题，比如clock skew， conflict resolution code， 冲突的修复操作，高并发下性能问题，基于quorums的latency问题</p>
<p>比较知名的系统如rethinkdb和mongoldb选择了数据一致性。应用构建在这之上会更简单，因为所有由数据一致性导致的问题都不存在。代价是应用可能会偶尔出现不可用的问题</p>
<p>在rethinkdb，如果存在网络分区，对某个客户端而言，系统的行为取决客户端在网络的哪个分区 。如果客户端在较多的选举的replica所在的网络分区中，操作不会有问题。如果客户端在小于等于一半选举的replica里，客户端up-to-date的查询和写操作都会遇到不可用问题。举个例子，如果客户端正在执行跨越多个分区的up-to-date的范围查询，所有的主分区必须和客户端在相同的网络分区内，否则客户端会遇到不可用性问题。</p>
<p>如果程序员标记一个读操能够容忍out-of-date的数据，rethinkdb会将查询路由到到最近的可用副本而不是主副本。在这种情况下只要客户端所在的网络分区有副本，客户端就能读到数据，只是这种情况下数据可能是过期的数据，这通常对报表、数据分析、数据缓存或其他对数据是否最新没有特别高要求的情况是没什么问题。 </p>
<h4 id="集群的配置是如何传播的？"><a href="#集群的配置是如何传播的？" class="headerlink" title="集群的配置是如何传播的？"></a>集群的配置是如何传播的？</h4><p>更新集群的状态在分布式系统里是个出奇困难的问题。在任意时间点，不同（可能）冲突的配置可能被网络的不同分区选择，不同的配置可能在不确定的时间到达不同的节点。</p>
<p>通常情况下rethinkdb使用 raft算法去存储和传播集群的配置，虽然有一些场使用了semilattices<br>，内部时间戳版本。这种架构证明具有足够的精确性解决上述的所有问题</p>
<h2 id="Indexing"><a href="#Indexing" class="headerlink" title="Indexing"></a>Indexing</h2><h4 id="rethinkdb如何索引数据？"><a href="#rethinkdb如何索引数据？" class="headerlink" title="rethinkdb如何索引数据？"></a>rethinkdb如何索引数据？</h4><p>当用户创建表的时候，可以指定哪个属性作为primary key(如果没有primary key，默认是”id”).当用户向表中插入一个文档，如果文档包含primary key，则它的值会被用来索引文档，否则，将自动为索引生成一个随机唯一id。</p>
<p>rethinkdb根据每个文档的主键将文档放置到合适的分区，并在分区内建索引，索引使用B-Tree结构存储。通过主键查询文档非常高效，因为查询会立刻路由到对应的分区，同时在B-Tree上查找。</p>
<h4 id="rethinkdb支持二级索引和复合索引吗？"><a href="#rethinkdb支持二级索引和复合索引吗？" class="headerlink" title="rethinkdb支持二级索引和复合索引吗？"></a>rethinkdb支持二级索引和复合索引吗？</h4><p>rethinkdb支持二级索引和复合索引，同时也支持任意意表达式形式的索引。可以参考如何创建二级索引的API here.</p>
<h2 id="Availability-and-failover"><a href="#Availability-and-failover" class="headerlink" title="Availability and failover"></a>Availability and failover</h2><h4 id="当一个server不可用的时候会出现什么？"><a href="#当一个server不可用的时候会出现什么？" class="headerlink" title="当一个server不可用的时候会出现什么？"></a>当一个server不可用的时候会出现什么？</h4><p>如果一个集群至少有3个节点,大部分情况下rethinkdb会自动failover来确保表的可用性.<br>1.如果一个分片的主副本失效，只要每个分片的投票副本有超过一半可用，那么其中一个副本会成为新的主副本</p>
<p>2.如果某个分片有一半或者超过一半的副本不可用(包括2个server的集群挂了1台)，这个集群必须通过reconfigure的emergency repair选项来进行人工修复。<br>更多的细节可以看Failover.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/10/rethinkdb-architecture/" data-id="cio4gl70u0000fvas2lwdf84t" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/architecture/">architecture</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nosql/">nosql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rethinkdb/">rethinkdb</a></li></ul>

    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/">architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nosql/">nosql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rethinkdb/">rethinkdb</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/architecture/" style="font-size: 10px;">architecture</a> <a href="/tags/nosql/" style="font-size: 10px;">nosql</a> <a href="/tags/rethinkdb/" style="font-size: 10px;">rethinkdb</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/05/12/rethinkdb-architecture2/">(no title)</a>
          </li>
        
          <li>
            <a href="/2016/05/10/rethinkdb-architecture/">rethinkdb architecture</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>